![blockchain.jpg][1]

## 区块链是什么

区块链是一种在对等环境下，通过透明和可信规则，构建不可伪造、不可篡改和可追溯的块链式数据结构，实现和管理事务处理的模式。简单理解就是它是一个特殊的分布式数据库，通过在区块链网络上的共识算法，每个节点共享数据，保证了区块链的一致性以及安全性。

区块链技术经历了如下的发展：

(1)区块链 1.0

以比特币为代表的加密货币。

(2)区块链 2.0

以智能合约为依托的以太坊作为典型代表，也就是可编程区块链。

(3)区块链 3.0

到目前为止，区块链 3.0 还是有争议的，又说是 DAG 技术，也有说是超越货币和金融范围的其他应用。

## 区块链的优缺点

### 优点

- #### 分布式的去中心化

目前我们看到的绝大部分网络应用都是中心化网络，而这种过于集中的中心化网络有一个致命的缺陷，就是一旦出现故障，会导致整个系统都受到影响破坏。

而区块链网络是基于 P2P 技术实现的，并不存在中央服务器的概念，网络中每个节点都是对等的，都可以提供独立的服务。这样即使一部分节点出现故障，也不会影响到整个区块链网络的运行。

- #### 无需信任系统

在一个中心化的网络中，我们是通过信任一个作为中介的第三方机构(如银行、支付宝、淘宝等)，由它来背书保证，然后我们才可以放心进行各种交易。而区块链则通过现代密码学技术和共识算法（POW 工作量证明），让我们可以实现去中心化，将信任从第三方机构转移到区块链网络。

- #### 不可篡改

区块链是一个基于密码学的分布式账本，每个区块按照时间线性顺序推进。同时通过共识算法，节点之间最终会对共享账本达成一致性。要想要篡改区块链网络中的数据，就需要掌握全网 50%以上的算力才可以控制整个网络，也就是我们常说的”51%攻击”。而在区块链网络中，要想掌握全网 50%以上的算力是要付出巨大的成本的，区块链中每个区块的产生是需要付出算力成本，而且随着区块链的高度越来越高，巨大的算力成本使得篡改的可能性就几乎为零。

### 缺点

- #### 交易账本必须公开

在公有链上，每个节点都可以存储一份完整的账本数据，同时交易数据也是公开透明，账本中的每一笔交易都可以进行追随。

- #### 延迟性

区块链的交易是存在一定的延迟性的，以比特币为例。它是每 10 分钟将自上一个区块以后的交易打包生成一个新区块，也就是说我们进行一笔比特币交易后，需要大概 10 分钟进行确认。而由于考虑到可能存在一些节点可能篡改区块数据，最好是在生成 6 个区块后以后才可以确认数据几乎不会被篡改，也就是要将近一个小时。

- #### 占用空间

我们知道区块链网络中，每一个节点都可以存储共享一份全网的账本数据，但是随着交易数量的增加，每个节点存储的数据就会非常大。目前比特币要想同步完整的账本数据，需要至少上百 G 的空间。

## 区块链关键技术

### 区块结构+链式结构

区块链中每一个区块的结构如下图所示，由区块头和区块体构成。

区块头中包含以下信息：

- #### 版本号：用于跟踪软件/协议的更新

- #### 父区块的哈希：引用区块链中父区块的哈希值

- #### 时间戳：该区块产生的时间

- #### 目标哈希：当前区块的哈希值

- #### 随机数(Nonce)：用于工作量证明算法的技术器

- #### Merkle 根：该区块中交易的 merkle 树根的哈希值

- #### 区块高度：记录该区块在区块链中位置

区块体中保存的是来自上一个区块以来的交易数据。

![区块体_1.png][2]

然后每个区块通过连接上一个区块，最终形成一条长链，如下图所示：

![链式结构_2.png][3]

### Merkle 树

区块链中每一个区块都包含了该区块的所有交易数据，并且以如下图所示的 Merkle 树表示。

![Merkle_3.png][4]

Merkle 树由一个根节点、一组中间节点和一组叶节点组成。最下面的叶子节点可以存储哈希值或者数据，每个中间节点是两个子节点的内容的哈希值，而根节点同样也是由两个子节点的内容的哈希值组成。

我们可以发现，只要存储数据的叶子节点有任何的变动，都会传递到相应的父节点，最终其 Merkle 树的根节点都会发生变化。

### P2P 网络

区块链作为分布式网络，其实现的关键就是基于 P2P 网络。P2P 技术发展到现在，已经经历了3代的发展。

第1代：采用中央服务器的模式，每个节点都需要先连接中央服务器才能知道其他节点的位置，这种技术有个致命缺陷—单点故障。典型代表是：Napster。

第2代：采用广播的模式，每个节点在定位资源或节点的时候，会向自己相连的所有节点进行询问，被问到的节点如果不知道结果也执行同样操作，直到找到资源或节点位置。这种技术的一个问题是会引发”广播风暴”并严重占用网络带宽。典型代表是：Gnutella的早期版本。

第3代：也是目前广泛使用的分布式哈希表（简称 DHT）技术，解决了前两代中出现的单点故障问题和广播风暴问题。
[DHT 技术简介][5]

### 挖矿与共识

在区块链网络中，每一笔交易的产生都会广播到网络中其他节点。挖矿实际上是对当前节点上所接收到的交易进行验证打包，并将产生的区块通过区块链网络广播出去，同时奖励产生该区块的矿工一定的奖励（加密货币）。然后区块链网络通过共识算法最终会决定是否将该区块的数据写入到共享账本中。而区块链网络中，区块产生的速度是一个常量，例如比特币是每10分钟产生一个区块。

那么，这里面有4个关键问题：

- #### 为什么需要挖矿这个过程？

- #### 如何挖矿，也就是挖矿过程是怎样的？

- #### 如何调整区块的产生速度，例如比特币如何保证每10分钟产生一个区块？

- #### 如何达成共识，区块链网络中如何对新产生的区块进行确认？

下面我们一个个来分析。

**(1)为什么需要挖矿这个过程？**

挖矿在区块链网络中不仅能增加货币，同时它还能保障区块链安全。挖矿会对区块中的每一笔交易进行校验，防止出现欺诈交易。

挖矿中每产生的一个区块，都对对应奖励矿工一定的货币，这实际上就类似于央行的发行货币的功能。同时，在该区块上产生的交易需要支付一定的交易费用给产生该区块的矿工（这也是后期货币发行完以后，矿工的主要收入），这会激励更多的矿工参与挖矿，从而保证了区块链网络中产生的交易能被记录到共享账本中。

同时，挖矿产生一个有效区块是需要工作量证明，也就是需要付出一定的算力成本。如果某个黑客想要篡改某个交易，它不仅要重新计算该交易所在区块之后所有区块的Hash数据，同时还需要保证全网50%以上的算力才能保证自己篡改的数据可以被全网接收。这使得对攻击者来需要付出巨大的经济成本，通过经济惩罚来保障区块链的安全。

**(2)如何挖矿？**

区块链网络中，每个节点时刻监听着网络中产生的新的交易和区块。同时，每个节点会接收区块链网络中产生的交易，并对这些交易数据进行各种校验，防止出现欺诈交易出现。并把这些有效的交易打包成一个候选区块。

在得到一个候选区块之后，接下来要做的事情就是通过工作量证明机制（POW）证明这个区块有效。简单地说就是重复计算区块头的哈希值，通过不断修区块头中的参数（nonce），直到产生一个哈希值小于某一个目标值为止。由此证明了该区块的有效性，之后就可以将该区块广播出去，告诉其它节点一个新的区块已经产生了，其它节点在得知当前高度的区块已经被挖掘出来以后，就结束当前正在挖掘的区块，开始进入下一个区块的挖掘。

**(3)如何调整区块的产生速度？**

我们知道比特币是每10分钟产生一个区块，即使全网算力增加或者减少，它也能保证产生一个区块的时间在10分钟左右，那它是怎么做到的呢？

在比特币网络中，每个区块头都会包含一个难度系数。在(2)中我们提到，挖矿证明一个区块有效，实际上就是不停地对区块头进行哈希，直到找到某一个哈希值小于目标值为止。

这里目标值就根这个难度系数是有关联的。

在区块链协议中，规定使用一个常量除以难度系数就可以得到目标值。可见，难度系数越大，则相应目标值就越小，那么挖矿需要运算的次数更多。

**target=target_max/difficulty**

而比特币怎么知道自己的算力是提高了还是降低了呢？

比特币每发现2016个区块时，会根据前2016个区块完成的时间对难度进行调整，如果之前2016个区块所花时间变少了，也就是全网算力提升了，则提高难度系数，则目标值变小；如果所花时间变多，则就是出现全网算力下降了，则降低难度系数，则目标值变大。

**(4)如何达成共识？**

共识机制在区块链中扮演者核心的地位，共识机制决定了谁拥有记账的权利。

POW，工作量证明机制，通过一个竞争机制（计算猜测一个nonce随机值，得以解决规定的哈希问题），让计算工作完成最出色的节点获得记账的权利。这样可以保证一段时间内，只会出现少数几个同一高度的合法区块。而POW通过这种算力消耗的经济惩罚限制了恶意的参与，因为它需要付出大量的经济成本。

同时，这些合法的区块会在区块链网络中进行广播，收到的节点会将区块添加到自己维护的最长链上。所以这时候有可能当前节点同时收到两个同一高度的合法区块，也就会出现分叉，但是最终随着挖矿的继续运行，最终会有一条链成为最长链。

![共识机制_4.jpg][6]


  [1]: https://www.luozijian.com/usr/uploads/2019/07/988771085.jpg
  [2]: https://www.luozijian.com/usr/uploads/2019/07/1700728701.png
  [3]: https://www.luozijian.com/usr/uploads/2019/07/4049226392.png
  [4]: https://www.luozijian.com/usr/uploads/2019/07/3663635000.png
  [5]: https://www.bilibili.com/video/av57785743/
  [6]: https://www.luozijian.com/usr/uploads/2019/07/3362694310.jpg